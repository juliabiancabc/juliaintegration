{% extends "events_base.html" %}
{% block title %}Manage Events{% endblock %}
{% block content %}
<style>
    body { background: white !important; }
    .container { background: white !important; padding: 0 !important; max-width: 100% !important; margin: 0 !important; }
    .page-layout { display: flex; min-height: calc(100vh - 80px); }
    .sidebar { width: 200px; background: #5B4FE9; padding: 30px 20px; }
    .sidebar-title { color: white; font-size: 14px; margin-bottom: 20px; font-weight: 600; }
    .sidebar-item { color: white; padding: 10px 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .sidebar-item.active { background: rgba(255,255,255,0.2); }
    .main-area { flex: 1; padding: 30px 40px; background: white; }
    .header { font-size: 22px; font-weight: 600; margin-bottom: 25px; color: #5B4FE9; }
    .toolbar { display: flex; gap: 15px; margin-bottom: 25px; align-items: center; }
    .new-event-btn { background: #5B4FE9; color: white; padding: 8px 18px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; }
    .search-box { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 200px; font-size: 13px; }
    .filter-dropdown { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
    .section-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .section-label { font-size: 16px; font-weight: 600; }
    .legend { display: flex; gap: 20px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot-blue { background: #5B4FE9; }
    .dot-yellow { background: #FFC107; }
    .dot-gray { background: #9E9E9E; }
    .events-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .event-card { background: white; border: 1px solid #E0E0E0; border-radius: 10px; overflow: hidden; }
    .event-img { height: 140px; background: #E8E8E8; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; }
    .event-body { padding: 16px; }
    .event-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .spaces { font-size: 12px; color: #666; margin-bottom: 12px; }
    .event-info { font-size: 11px; color: #666; margin-bottom: 3px; }
    .view-btn { width: 100%; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; color: inherit; }
    .view-btn:hover { background: #F8F9FF; border-color: #5B4FE9; }
    .signups-btn { width: 100%; padding: 8px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .signups-btn:hover { background: #218838; }
    .back-btn { font-size: 24px; color: #5B4FE9; text-decoration: none; }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: white; margin: 5% auto; padding: 0; border-radius: 10px; width: 80%; max-width: 900px; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 18px; font-weight: 600; color: #5B4FE9; }
    .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }
    .close:hover { color: #000; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: flex-end; }
    
    /* Table Styles */
    .registrations-table { width: 100%; border-collapse: collapse; }
    .registrations-table th { background: #f5f5f5; padding: 12px; text-align: left; font-size: 12px; font-weight: 600; border-bottom: 2px solid #ddd; }
    .registrations-table td { padding: 12px; font-size: 12px; border-bottom: 1px solid #eee; }
    .registrations-table tr:hover { background: #f9f9f9; }
    .no-registrations { text-align: center; padding: 40px; color: #999; }
    .action-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
    .unregister-btn { background: #dc3545; color: white; }
    .unregister-btn:hover { background: #c82333; }
    .export-btn { background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
    .export-btn:hover { background: #218838; }
</style>

<div class="page-layout">
    <div class="sidebar">
        <div class="sidebar-title">Event Navigation</div>
        <a href="{{ url_for('manage_events') }}" class="sidebar-item {% if request.endpoint in ['manage_events', 'create_event', 'view_event_detail', 'edit_event'] %}active{% endif %}" style="text-decoration: none;">
            <span>üìã</span>
            <span>Manage Events</span>
        </a>
        <a href="{{ url_for('attendee_insights') }}" class="sidebar-item {% if request.endpoint == 'attendee_insights' %}active{% endif %}" style="text-decoration: none;">
            <span>üìä</span>
            <span>Attendee Insights</span>
        </a>
    </div>

    <div class="main-area">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <a href="{{ url_for('admin_dashboard') }}" class="back-btn" style="text-decoration: none;">‚Üê </a>
                <span>Event Management Section</span>
            </div>
        </div>

        <div class="toolbar">
            <a href="{{ url_for('create_event') }}" class="new-event-btn">+ New Event</a>
            <a href="{{ url_for('export_events') }}" class="new-event-btn" style="background: #28a745;">üì• Export to Excel</a>

            <input type="text" id="searchBox" class="search-box" placeholder="Search events..." onkeyup="filterEvents()">
            <select id="typeFilter" class="filter-dropdown" onchange="filterEvents()">
                <option value="all">All Types</option>
                <option value="physical">Physical</option>
                <option value="virtual">Virtual</option>
                <option value="closed">Closed</option>
            </select>
            <select id="sortFilter" class="filter-dropdown" onchange="sortEvents()">
                <option value="latest">Latest Events</option>
                <option value="oldest">Oldest Events</option>
            </select>
        </div>

        <div class="section-bar">
            <div class="section-label">All Events</div>
            <div class="legend">
                <div class="legend-item"><div class="dot dot-blue"></div><span>Virtual</span></div>
                <div class="legend-item"><div class="dot dot-yellow"></div><span>Physical</span></div>
                <div class="legend-item"><div class="dot dot-gray"></div><span>Closed Events</span></div>
            </div>
        </div>

        {% if events %}
        <div class="events-grid">
            {% for event in events %}
            <div class="event-card" data-date="{{ event.date.strftime('%Y-%m-%d') }}">
                <div class="event-img">
                    {% if event.image_filename %}
                    <img src="{{ url_for('static', filename='uploads/' + event.image_filename) }}" style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                    Event Image
                    {% endif %}
                </div>
                <div class="event-body">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="dot {% if event.event_type == 'virtual' %}dot-blue{% else %}dot-yellow{% endif %}"></div>
                        <div class="event-title">{{ event.title }}</div>
                    </div>
                    <div class="spaces">üìÖ {{ event.available_capacity }}/{{ event.seat_amount or 70 }} spaces left</div>
                    <div class="event-info event-venue">Venue: {{ event.location }}</div>
                    <div class="event-info event-date">Date: {{ event.date.strftime('%d %B %Y') }}</div>
                    <div class="event-info event-time">Time: {{ event.date.strftime('%I:%M%p') }}</div>
                    <a href="{{ url_for('view_event_detail', event_id=event.id) }}" class="view-btn">
                        <span>üëÅ</span><span>View</span>
                    </a>
                    <button class="signups-btn" onclick="showRegistrations({{ event.id }}, '{{ event.title }}')">
                        <span>üë•</span><span>Current Sign-ups </span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 60px; color: #999;">
            <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
            <h3>No Events Yet</h3>
            <p>Create your first event!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Registration Modal -->
<div id="registrationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Event Registrations</div>
            <span class="close" onclick="closeRegistrationModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="registrationContent">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                    <p>Loading registrations...</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="export-btn" id="exportRegistrationsBtn" style="display: none;">üì• Export to Excel</button>
            <button onclick="closeRegistrationModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
        </div>
    </div>
</div>

<script>
function filterEvents() {
    const search = document.getElementById('searchBox').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const cards = document.querySelectorAll('.event-card');

    cards.forEach(card => {
        const title = card.querySelector('.event-title');
        const venue = card.querySelector('.event-venue');
        
        if (!title || !venue) return;
        
        const titleText = title.textContent.toLowerCase();
        const venueText = venue.textContent.toLowerCase();
        const eventType = card.querySelector('.dot').classList.contains('dot-blue') ? 'virtual' : 'physical';

        const matchesSearch = titleText.includes(search) || venueText.includes(search);
        const matchesType = typeFilter === 'all' || typeFilter === eventType;

        card.style.display = (matchesSearch && matchesType) ? 'block' : 'none';
    });
}

function sortEvents() {
    const sortBy = document.getElementById('sortFilter').value;
    const grid = document.querySelector('.events-grid');
    const cards = Array.from(document.querySelectorAll('.event-card'));

    if (!grid || cards.length === 0) return;

    cards.sort((a, b) => {
        const dateA = new Date(a.getAttribute('data-date'));
        const dateB = new Date(b.getAttribute('data-date'));

        if (sortBy === 'latest') {
            return dateB - dateA;
        } else {
            return dateA - dateB;
        }
    });

    grid.innerHTML = '';
    cards.forEach(card => grid.appendChild(card));
}

async function showRegistrations(eventId, eventTitle) {
    const modal = document.getElementById('registrationModal');
    const modalTitle = document.getElementById('modalTitle');
    const content = document.getElementById('registrationContent');
    const exportBtn = document.getElementById('exportRegistrationsBtn');
    
    modalTitle.textContent = `Registrations for "${eventTitle}"`;
    modal.style.display = 'block';
    
    // Show loading
    content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
            <p>Loading registrations...</p>
        </div>
    `;
    
    try {
        const response = await fetch(`/admin/event/${eventId}/registrations`);
        const data = await response.json();
        
        if (data.registrations && data.registrations.length > 0) {
            let tableHTML = `
                <table class="registrations-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Special Requests</th>
                            <th>Registered At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.registrations.forEach(reg => {
                tableHTML += `
                    <tr>
                        <td>${reg.username}</td>
                        <td>${reg.special_requests || '<em>None</em>'}</td>
                        <td>${reg.registered_at}</td>
                        <td>
                            <button class="action-btn unregister-btn" onclick="unregisterUser(${eventId}, ${reg.user_id}, '${reg.username}')">
                                Unregister
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            content.innerHTML = tableHTML;
            exportBtn.style.display = 'inline-block';
            exportBtn.onclick = () => exportRegistrations(eventId);
        } else {
            content.innerHTML = `
                <div class="no-registrations">
                    <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                    <h3>No Registrations Yet</h3>
                    <p>No one has signed up for this event yet.</p>
                </div>
            `;
            exportBtn.style.display = 'none';
        }
    } catch (error) {
        content.innerHTML = `
            <div class="no-registrations">
                <div style="font-size: 48px; margin-bottom: 15px; color: #dc3545;">‚ùå</div>
                <h3>Error Loading Registrations</h3>
                <p>${error.message}</p>
            </div>
        `;
        exportBtn.style.display = 'none';
    }
}

function closeRegistrationModal() {
    document.getElementById('registrationModal').style.display = 'none';
}

async function unregisterUser(eventId, userId, username) {
    if (!confirm(`Are you sure you want to unregister ${username} from this event?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/event/${eventId}/unregister/${userId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('User unregistered successfully!');
            // Reload the registration list
            const modalTitle = document.getElementById('modalTitle').textContent;
            const eventTitle = modalTitle.replace('Registrations for "', '').replace('"', '');
            showRegistrations(eventId, eventTitle);
            // Reload page to update counts
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error unregistering user: ' + error.message);
    }
}

function exportRegistrations(eventId) {
    window.location.href = `/admin/event/${eventId}/registrations/export`;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('registrationModal');
    if (event.target == modal) {
        closeRegistrationModal();
    }
}
</script>
{% endblock %}
